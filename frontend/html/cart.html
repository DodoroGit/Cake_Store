<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è³¼ç‰©è»Š</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>ğŸ›’ æˆ‘çš„è³¼ç‰©è»Š</h1>

  <div id="cart-items"></div>
  <p id="total"></p>

  <button onclick="submitOrder()">é€å‡ºè¨‚å–®</button>
  <button onclick="clearCart()">æ¸…ç©ºè³¼ç‰©è»Š</button>

  <script>
    const token = localStorage.getItem("token");
    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    const container = document.getElementById("cart-items");

    function renderCart() {
      container.innerHTML = "";
      let total = 0;

      cart.forEach((item, index) => {
        const subtotal = item.price * item.quantity;
        total += subtotal;

        const div = document.createElement("div");
        div.innerHTML = `
          <h3>${item.name} - $${item.price} x ${item.quantity} = $${subtotal}</h3>
          <button onclick="removeItem(${index})">ç§»é™¤</button>
          <hr/>
        `;
        container.appendChild(div);
      });

      document.getElementById("total").textContent = "ç¸½é‡‘é¡ï¼š$" + total;
    }

    function removeItem(index) {
      cart.splice(index, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    }

    function clearCart() {
      localStorage.removeItem("cart");
      location.reload();
    }

    function submitOrder() {
      if (cart.length === 0) {
        alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼");
        return;
      }

      const orderItems = cart.map(item => ({
        productID: item.productID,
        quantity: item.quantity
      }));

      fetch("/graphql", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({
          query: `
            mutation($items: [OrderItemInput!]!) {
              createOrder(items: $items)
            }
          `,
          variables: { items: orderItems }
        })
      })
      .then(res => res.json())
      .then(res => {
        if (res.data?.createOrder) {
          alert("âœ… è¨‚å–®é€å‡ºæˆåŠŸï¼");
          localStorage.removeItem("cart");
          window.location.href = "member.html";
        } else {
          alert("âŒ è¨‚å–®å¤±æ•—ï¼š" + (res.errors?.[0]?.message || "æœªçŸ¥éŒ¯èª¤"));
        }
      });
    }

    renderCart();
  </script>
</body>
</html>
